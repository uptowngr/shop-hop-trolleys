<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trolley Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* Live trolley icons */
    .trolley-icon {
      font-size: 22px;
      text-align: center;
      line-height: 24px;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    .trolley-red {
      background-color: #dc2626; /* red */
      color: #ffffff;
    }
    .trolley-green {
      background-color: #16a34a; /* green */
      color: #ffffff;
    }

    /* Stop markers (numbered) */
    .stop-icon {
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
      font-weight: 600;
    }
    .stop-green {
      background-color: #16a34a;
      color: #ffffff;
    }
    .stop-red {
      background-color: #dc2626;
      color: #ffffff;
    }

    /* Parking markers */
    .parking-icon {
      font-size: 14px;
      text-align: center;
      line-height: 22px;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
      background-color: #2563eb; /* blue */
      color: #ffffff;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ðŸ” Optimus API settings
    const API_URL = 'https://api3p.optimustracking.com/v1/clients/5540/position/latest';
    const API_KEY = 'ef5cc554-ab98-4719-9a28-e919ba8558f2'; // update here if you regenerate the key

    // 2 red line trolleys, 3 green line trolleys
    const DEVICE_CONFIG = {
      525208: { label: 'Red Line 1',   line: 'red' },
      525217: { label: 'Red Line 2',   line: 'red' },
      525245: { label: 'Green Line 1', line: 'green' },
      525285: { label: 'Green Line 2', line: 'green' },
      525979: { label: 'Green Line 3', line: 'green' }
    };

    // Businesses per stop (from your CSV, including secondary stop numbers)
    const BUSINESSES_BY_STOP = {
      1: [
        "Ageless Beauty",
        "Foxtail Coffee",
        "Hancock Grand Rapids",
        "Louise Earl Butcher",
        "Plant Shop, The",
        "Sacred Springs Kombucha",
        "Scorpion Hearts Club",
        "The Mitten Insurance Agency",
        "Uncle Cheetah's Soup Shop",
        "Unwind GR",
        "Verhey Carpets",
      ],
      2: [
        "Alby & Co - Barber",
        "Apsara Spa",
        "Asada",
        "Billy's Lounge",
        "Brown Butter Creperie & Cafe",
        "Chez Olga",
        "Cobbler, The",
        "Dominos Pizza",
        "Earthly Refillery",
        "East Building Management",
        "Eastown Sports Bar & Grill",
        "Gojo Ethiopian Cuisine",
        "Harmony Brewing Company",
        "High Tea",
        "Local Epicurean, The",
        "Mulligan's Pub",
        "New Yorker Menswear",
        "Pita House",
        "Pizza Hut/Wing Street",
 	"Psycle Sam's Heady Glass",
        "Vinyl Alchemy",
        "Yesterdog",
      ],
      3: [
        "Ash & Elm Quiltery",
        "BC Pizza",
        "Cottage Inn Pizza",
        "East Building",
        "Eastown Pediatric Dentistry",
        "Freshwater Whale",
        "Gino's Pizza",
        "Gojo Ethiopian Cuisine",
        "Harmony Brewing Company",
        "Jimmy John's",
        "Rebel",
        "Smitty's Specialty Beverage",
        "Spirit Dreams",
        "Sticky Fingers",
        "Tamales Mary's",
      ],
      4: [
        "Connie's Cakes",
        "El Cerrito",
        "Gallery 154",
        "Quarantino's Pizza",
        "Smitty's Specialty Beverage",
        "Spirit Dreams",
        "Sticky Fingers",
        "Terra Bagel",
        "Terra GR",
        "That Early Bird",
        "Wax Poetic",
        "Yours Truly Galleria",
      ],
      5: [
        "Argos Comics and Used Books",
        "Connie's Cakes",
        "El Cerrito",
        "Fruition Acai & Juice Bar",
        "Funky Buddha Yoga",
        "Matchbox Diner",
        "Pursuit of Happiness Co",
        "Redux Books",
        "Terra Bagel",
        "Terra GR",
        "The Parlour 616",
        "Wax Poetic",
        "Yours Truly Galleria",
      ],
      6: [
        "Drunken Monkey Smoke Shop",
        "Rooted in Wellness",
        "Sugah Please",
      ],
      7: [
        "Always, Betti Estate Jewelry",
        "Shop Hop Maker Market - Fulton Street Farmers Market",
        "Mi Bella Guatemala Mi Pueblito",
      ],
      8: [
        "Arts In Motion",
        "Clothing Matters",
        "Global Infusion",
        "Rock Paper Scissors Consignment Boutique",
      ],
      // 9: [] // no businesses assigned for stop 9 (LaFontsee Green stop)
      10: [
        "Adored Boutique",
        "Books & Mortar",
        "Chateau Grand Rapids",
        "Cherry Hill Market",
        "Commune",
        "Covet Leisure",
        "Furniture City Creamery",
        "Gemini Handmade",
        "Grove",
        "Harmonic Egg & Wellness GR",
        "Honey Jewelry Co",
        "Hopscotch Children's Store",
        "Kava Kasa",
        "KCM",
        "Le Bon Macaron",
        "Less Traveled",
        "Mangiamos",
        "Maru Sushi & Grill",
        "Metal Art Studio",
        "Nestology Shop & Studio",
        "New Design Floral",
        "Red Bowl",
        "Rise Wellness Chiropractic",
        "Ritual Wines",
        "Sovereign Arms Tattoo Co.",
        "Vape City Smoke Shop",
        "Vivant Brewery & Spirits",
      ],
      11: [
        "Adored Boutique",
        "Books & Mortar",
        "Chateau Grand Rapids",
        "Cherry Hill Market",
        "Commune",
        "Covet Leisure",
        "Furniture City Creamery",
        "Gemini Handmade",
        "Grove",
        "Harmonic Egg & Wellness GR",
        "Honey Jewelry Co",
        "Hopscotch Children's Store",
        "Kava Kasa",
        "KCM",
        "Le Bon Macaron",
        "Less Traveled",
        "Mangiamos",
        "Maru Sushi & Grill",
        "Metal Art Studio",
        "Nestology Shop & Studio",
        "New Design Floral",
        "Red Bowl",
        "Rise Wellness Chiropractic",
        "Ritual Wines",
        "Rock Paper Scissors Consignment Boutique",
        "Sovereign Arms Tattoo Co.",
        "Vape City Smoke Shop",
        "Vivant Brewery & Spirits",
      ],
      12: [
        "Black Dog Used Books and Records",
        "Black Napkin",
        "Blue Bridge Games",
        "Buffalo Traders Lounge",
        "Cakabakery, The",
        "Ghosthouse",
        "Hard Times",
        "Inner Body Works and Peak Performance LLC",
        "Little Africa Ethiopian Cuisine",
        "MercuryHead Gallery",
        "Rakowski Family Farm & Market",
        "Spike & Mike's Party Store",
        "Stovetop Coffee Roasters",
        "The Dirty Plate Bistro",
        "Tienda Emy Latina",
        "Urban Exchange Consignment Boutique",
      ],
      13: [
        "Art of the Table",
        "City2Shore Real Estate",
        "Dime and Regal",
        "Donkey Taqueria",
        "Eastern Kille Distillery",
        "Good Truckin' Diner",
        "Modish Moth and LadyMonarch",
        "Mokaya Chocolate",
        "Niksi Home & Floral",
        "Roman James",
        "Rowster Coffee",
        "Sable Candle Company",
        "Stoffer Home",
        "The Grey Rabbit",
        "Wanderlux Beauty & Wellness Co.",
        "Wealthy Street Bakery",
        "Winchester, The",
      ],
      14: [
        "Basic Bee Boutique",
        "Better Aged Vintage",
        "Chartreuse Sisters",
        "City2Shore Real Estate",
        "Counting House, The",
        "Dime and Regal",
        "Donkey Taqueria",
        "Fusion Salon",
        "Good Truckin' Diner",
        "Jeffrey Richard Salon",
        "Kitchen Design Studio, Inc.",
        "Mammoth Distillery",
        "Modish Moth and LadyMonarch",
        "Mokaya Chocolate",
        "Niksi Home & Floral",
        "Popnotch Goods",
        "Roman James",
        "Stoffer Home",
        "The Grey Rabbit",
        "Wanderlux Beauty & Wellness Co.",
        "Woosah Outfitters",
        "Zivio",
      ],
      15: [
        "Electric Cheetah, The",
        "Feral Mountain Co",
        "IC Hair & Vintage",
        "Plant Shop, The",
        "Sacred Springs Kombucha",
        "Scorpion Hearts Club",
        "Speciation Cellars",
        "Squibb Coffee & Wine Bar",
        "Testa Rossa Pizzeria",
        "Thai Table",
        "Toppers Pizza",
        "Unwind GR",
        "Vetr Health",
        "Zivio",
      ],
    };

    // Static stops + parking
    const STOPS = [
      // Green line stops 1â€“10
      { type: 'stop', line: 'green', number: 1,  name: 'Wealthy Theatre', address: '1130 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.95548597799767, lng: -85.64078586630116 },
      { type: 'stop', line: 'green', number: 2,  name: 'The Local Epicurean', address: '1440 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.95543747164679, lng: -85.63330310261327 },
      { type: 'stop', line: 'green', number: 3,  name: 'Rebel', address: '1555 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.955609466309866, lng: -85.63046640913912 },
      { type: 'stop', line: 'green', number: 4,  name: 'That Early Bird', address: '1445 Lake Dr SE, Grand Rapids, MI 49506', lat: 42.956775585789394, lng: -85.63366660234925 },
      { type: 'stop', line: 'green', number: 5,  name: 'Argos Comics', address: '1405 Robinson Rd SE, Grand Rapids, MI 49506', lat: 42.95770013065598, lng: -85.63538089807697 },
      { type: 'stop', line: 'green', number: 6,  name: 'Common Ground', address: '1319 Fulton St E, Grand Rapids, MI 49503', lat: 42.96280268384934, lng: -85.63684098864623 },
      { type: 'stop', line: 'green', number: 7,  name: 'Shop Hop Maker Market (Fulton Street Farmers Market)', address: '1145 Fulton St E, Grand Rapids, MI 49503', lat: 42.96283637660817, lng: -85.6405724420557 },
      { type: 'stop', line: 'green', number: 8,  name: 'Blackport Shoppes', address: '147 Diamond Ave SE, Grand Rapids, MI 49506', lat: 42.960544268310485, lng: -85.64460253640993 },
      { type: 'stop', line: 'green', number: 9,  name: 'LaFontsee Galleries (Green Stop)', address: '833 Lake Dr SE, Grand Rapids, MI 49506', lat: 42.96082147405306, lng: -85.64826719542017 },
      { type: 'stop', line: 'green', number: 10, name: 'Commune (Transfer to Red Line Across the Street!)', address: '954 Cherry St SE, Grand Rapids, MI 49506', lat: 42.95948956626292, lng: -85.6454147020945 },

      // Red line stops 11â€“15
      { type: 'stop', line: 'red', number: 11, name: 'Covet (Transfer to Green Line Across the Street!)', address: '953 Cherry St SE, Grand Rapids, MI 49506', lat: 42.95963241209495, lng: -85.64541765644533 },
      { type: 'stop', line: 'red', number: 12, name: 'Black Dog Books & Records', address: '959 Fulton St E, Grand Rapids, MI 49503', lat: 42.962869612513174, lng: -85.6450024973559 },
      { type: 'stop', line: 'red', number: 13, name: 'Art of the Table', address: '606 Wealthy St SE, Grand Rapids, MI 49503', lat: 42.95561281161292, lng: -85.65381533745294 },
      { type: 'stop', line: 'red', number: 14, name: 'Basic Bee', address: '804 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.95552464670077, lng: -85.6489507499085 },
      { type: 'stop', line: 'red', number: 15, name: 'Speciation Cellars', address: '928 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.95549411214267, lng: -85.64569557903121 },

      // Parking (blue P)
      { type: 'parking', name: 'Parking â€“ LaFontsee Gallery', address: '833 Lake Dr SE, Grand Rapids, MI 49506', lat: 42.9615267330675, lng: -85.64882286194508 },
      { type: 'parking', name: 'Parking â€“ Trinity United Methodist Church', address: '1100 Lake Dr SE, Grand Rapids, MI 49506', lat: 42.95813071362794, lng: -85.64141574918084 },
      { type: 'parking', name: 'Parking â€“ Wellsprings Church of Grand Rapids', address: '811 Wealthy St SE, Grand Rapids, MI 49506', lat: 42.95576525078274, lng: -85.64819820436703 },
      { type: 'parking', name: 'Parking â€“ Fulton St Farmers Market', address: '1145 Fulton St E, Grand Rapids, MI 49503', lat: 42.9631669348111, lng: -85.64025646416641 },
      { type: 'parking', name: 'Parking â€“ Monarch Investment', address: '920 Cherry St SE, Grand Rapids, MI 49506', lat: 42.95909183834129, lng: -85.64637024190142 }
    ];

    // Map init â€“ center roughly on Uptown
    const map = L.map('map').setView([42.9585, -85.6450], 14);

    // ðŸ—ºï¸ Nicer free tiles: Carto Voyager
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    // Live trolley icons
    const redTrolleyIcon = L.divIcon({
      className: 'trolley-icon trolley-red',
      html: 'ðŸšŒ',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });

    const greenTrolleyIcon = L.divIcon({
      className: 'trolley-icon trolley-green',
      html: 'ðŸšŒ',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });

    const markers = {}; // deviceId -> Leaflet marker
    let firstFit = true;

    function getConfigForDevice(id) {
      const cfg = DEVICE_CONFIG[id];
      if (cfg) return cfg;
      // Fallback if a new device ever appears
      return { label: 'Device ' + id, line: 'red' };
    }

    function getIconForLine(line) {
      return line === 'green' ? greenTrolleyIcon : redTrolleyIcon;
    }

    async function fetchPositions() {
      try {
        const res = await fetch(API_URL, {
          headers: {
            'accept': 'application/json',
            'api-key': API_KEY
          }
        });

        if (!res.ok) {
          console.error('API error:', res.status, res.statusText);
          return;
        }

        const data = await res.json();
        const points = [];

        data.forEach(pos => {
          const id = pos.deviceId;
          const lat = Number(pos.latitude);
          const lng = Number(pos.longitude);

          if (Number.isNaN(lat) || Number.isNaN(lng)) return;

          const cfg = getConfigForDevice(id);
          const label = cfg.label;
          const icon = getIconForLine(cfg.line);

          const popupHtml =
            `<strong>${label}</strong><br>` +
            `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br>` +
            (pos.battery ? `Battery: ${Number(pos.battery).toFixed(0)}%<br>` : '') +
            (pos.utcDate ? `Last update: ${pos.utcDate}` : '');

          if (!markers[id]) {
            markers[id] = L.marker([lat, lng], { icon })
              .addTo(map)
              .bindPopup(popupHtml);
          } else {
            markers[id].setLatLng([lat, lng]);
            markers[id].setIcon(icon);
            markers[id].setPopupContent(popupHtml);
          }

          points.push([lat, lng]);
        });

        // Fit view to live trolleys on first successful load

	const map = L.map('map').setView([42.9588, -85.6455], 15);


      } catch (err) {
        console.error('Fetch error:', err);
      }
    }

    function initStops() {
      STOPS.forEach(stop => {
        const lat = stop.lat;
        const lng = stop.lng;

        if (stop.type === 'stop') {
          // Numbered stop icons
          const cls = stop.line === 'green' ? 'stop-icon stop-green' : 'stop-icon stop-red';
          const icon = L.divIcon({
            className: cls,
            html: String(stop.number),
            iconSize: [22, 22],
            iconAnchor: [11, 11]
          });

          let popupHtml =
            `<strong>Stop ${stop.number} â€“ ${stop.name}</strong><br>` +
            `${stop.address}`;

          // If we have businesses for this stop, add them as a list
          const businesses = BUSINESSES_BY_STOP[stop.number];
          if (businesses && businesses.length) {
            popupHtml += '<br><br><strong>Participating businesses at this stop:</strong><ul>';
            businesses.forEach(name => {
              popupHtml += `<li>${name}</li>`;
            });
            popupHtml += '</ul>';
          }

          L.marker([lat, lng], { icon })
            .addTo(map)
            .bindPopup(popupHtml);

        } else if (stop.type === 'parking') {
          // Blue P icons
          const icon = L.divIcon({
            className: 'parking-icon',
            html: 'P',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });

          const popupHtml =
            `<strong>${stop.name}</strong><br>` +
            `${stop.address}`;

          L.marker([lat, lng], { icon })
            .addTo(map)
            .bindPopup(popupHtml);
        }
      });
    }

    // Initialize static stops + parking
    initStops();

    // Initial fetch + refresh every 10 seconds (live view)
    fetchPositions();
    setInterval(fetchPositions, 10000);
  </script>
</body>
</html>
